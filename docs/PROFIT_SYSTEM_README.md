# 培训班课时管理系统 - 利润计算功能

## 🎯 功能概述

本系统新增了完整的利润计算功能，支持多种扣除项类型，能够准确计算学生和整体的利润情况。

## 🗄️ 数据库结构

### 新增表结构

#### 1. 扣除项配置表 (deduction_configs)
```sql
CREATE TABLE deduction_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,                    -- 扣除项名称
  type TEXT NOT NULL,                    -- 类型：percentage/fixed/per_hour
  value REAL NOT NULL,                   -- 值
  description TEXT,                      -- 说明
  is_active INTEGER DEFAULT 1            -- 是否启用
);
```

#### 2. 学生扣除项关联表 (student_deductions)
```sql
CREATE TABLE student_deductions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  student_id INTEGER NOT NULL,           -- 学生ID
  deduction_config_id INTEGER NOT NULL,  -- 扣除项配置ID
  FOREIGN KEY (student_id) REFERENCES students (id),
  FOREIGN KEY (deduction_config_id) REFERENCES deduction_configs (id)
);
```

## 🔧 扣除项类型

### 1. 百分比扣除 (percentage)
- **说明**: 按收入金额的百分比扣除
- **示例**: 场地租金15%，管理费10%
- **计算公式**: 扣除金额 = 收入 × 百分比

### 2. 固定金额扣除 (fixed)
- **说明**: 固定金额扣除，不受收入影响
- **示例**: 水电费200元，设备维护费150元
- **计算公式**: 扣除金额 = 固定金额

### 3. 每课时费用 (per_hour)
- **说明**: 按消耗课时数计算扣除
- **示例**: 教师课时费80元/课时
- **计算公式**: 扣除金额 = 课时数 × 每课时费用

## 📊 利润计算公式

```
利润 = 总收入 - 各项扣除总和
利润率 = (利润 / 总收入) × 100%
```

## 🚀 使用方法

### 1. 初始化系统

#### 步骤1: 运行数据库迁移
```bash
node migrate_db.js
```

#### 步骤2: 初始化扣除项配置
```bash
node init_deductions.js
```

#### 步骤3: 启动后端服务
```bash
node app.js
```

#### 步骤4: 启动前端服务
```bash
cd frontend
npm run dev
```

### 2. 扣除项管理

#### 访问扣除项管理页面
1. 在系统头部点击"扣除项管理"按钮
2. 或直接访问扣除项管理页面

#### 添加扣除项
1. 点击"添加扣除项"按钮
2. 填写名称、类型、值、说明等信息
3. 点击"添加"保存

#### 编辑扣除项
1. 在扣除项列表中点击"编辑"按钮
2. 修改相关信息
3. 点击"更新"保存

#### 启用/禁用扣除项
1. 在扣除项列表中点击"启用"或"禁用"按钮
2. 系统会自动更新状态

### 3. 学生扣除项配置

#### 配置学生扣除项
1. 在学生列表中点击学生姓名
2. 在学生详情页面找到"扣除项配置"卡片
3. 勾选需要应用的扣除项
4. 点击"保存配置"按钮

#### 查看学生利润
1. 在学生详情页面查看"利润分析"卡片
2. 显示总收入、总扣除、净利润、利润率
3. 点击"刷新利润"按钮重新计算

### 4. 整体利润统计

#### 查看整体利润
1. 在仪表板页面查看利润统计卡片
2. 支持按时间段筛选（全部、当月、本周、今日）
3. 自动计算各项扣除和净利润

## 🔌 API接口

### 扣除项管理API

#### POST /deduction-configs
- **功能**: 添加扣除项配置
- **请求体**: 
```json
{
  "name": "场地租金",
  "type": "percentage",
  "value": 15.0,
  "description": "按收入15%收取场地租金费用",
  "is_active": 1
}
```

#### GET /deduction-configs
- **功能**: 获取扣除项配置列表
- **响应**: 扣除项配置数组

#### PUT /deduction-configs/:id
- **功能**: 更新扣除项配置
- **请求体**: 同添加接口

### 学生扣除项API

#### GET /students/:id/deductions
- **功能**: 获取学生扣除项配置
- **响应**: 包含选中状态的扣除项列表

#### POST /students/:id/deductions
- **功能**: 更新学生扣除项配置
- **请求体**: 
```json
{
  "deduction_ids": [1, 2, 3]
}
```

### 利润计算API

#### GET /students/:id/profit
- **功能**: 计算学生利润
- **响应**: 
```json
{
  "success": true,
  "data": {
    "student": { "id": 1, "name": "张三", "phone": "13800138000" },
    "total_income": 1000,
    "total_hours": 20,
    "total_deductions": 250,
    "profit": 750,
    "profit_rate": 75.0,
    "deduction_details": [...]
  }
}
```

#### GET /profit
- **功能**: 计算总体利润
- **查询参数**: `period` (all/month/week/today)
- **响应**: 同学生利润接口

## 💡 使用示例

### 示例1: 配置学生扣除项
1. 学生张三充值1000元，购买20课时
2. 配置扣除项：场地租金15%、教师课时费80元/课时
3. 系统自动计算：
   - 场地租金：1000 × 15% = 150元
   - 教师课时费：20课时 × 80元 = 1600元
   - 总扣除：150 + 1600 = 1750元
   - 净利润：1000 - 1750 = -750元（亏损）

### 示例2: 查看整体利润
1. 本月总收入：5000元
2. 本月总课时：100课时
3. 扣除项配置：
   - 场地租金：5000 × 15% = 750元
   - 水电费：200元（固定）
   - 教师课时费：100 × 80 = 8000元
4. 总扣除：750 + 200 + 8000 = 8950元
5. 净利润：5000 - 8950 = -3950元（亏损）

## ⚠️ 注意事项

### 1. 数据一致性
- 删除学生时会自动删除相关的扣除项配置
- 禁用扣除项后，该扣除项不会参与利润计算

### 2. 性能考虑
- 利润计算涉及多个表的关联查询
- 大量数据时建议添加数据库索引
- 可以考虑缓存利润计算结果

### 3. 业务逻辑
- 百分比扣除基于总收入计算
- 每课时费用基于实际消耗课时计算
- 固定金额不受收入和时间影响

## 🔍 故障排除

### 1. 利润计算不准确
- 检查扣除项配置是否正确
- 确认学生扣除项配置是否保存
- 验证收入记录和课时记录是否完整

### 2. 扣除项不显示
- 检查扣除项是否启用
- 确认数据库表结构是否正确
- 查看API接口是否正常响应

### 3. 前端显示异常
- 检查浏览器控制台错误信息
- 确认API接口返回数据格式
- 验证Vue组件是否正确导入

## 🎉 总结

通过新增的利润计算功能，系统现在能够：

✅ **精确计算利润**: 支持多种扣除项类型，准确计算净利润和利润率
✅ **灵活配置扣除项**: 可以添加、编辑、启用/禁用各种扣除项
✅ **个性化配置**: 每个学生可以配置不同的扣除项组合
✅ **实时统计**: 支持按时间段查看整体利润情况
✅ **详细分析**: 显示各项扣除的计算方式和金额明细

这套利润计算系统为培训班管理提供了完整的财务分析工具，帮助管理者了解真实的盈利状况，做出更明智的经营决策。
